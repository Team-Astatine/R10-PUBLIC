package org.Astatine.r10.Contents.Restricted.AntiExploit.Interaction.LeverInteraction;

import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.ObjectUtils;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import org.Astatine.r10.Enumeration.Type.ColorType;
import org.Astatine.r10.Contents.EventRegister;
import org.Astatine.r10.Util.Function.StringComponentExchanger;

import java.time.LocalDateTime;

public class LeverInteractionHandler extends StringComponentExchanger implements EventRegister {
    private Player player;
    private Action action;
    private Block clickedBlock;
    private LeverActionStatus leverActionStatus;
    private final PlayerInteractEvent event;

    public LeverInteractionHandler(PlayerInteractEvent event) {
        this.event = event;
        init();
        execute();
    }

    @Override
    public void init() {
        this.player = this.event.getPlayer();
        this.action = this.event.getAction();
        this.clickedBlock = this.event.getClickedBlock();
        this.leverActionStatus = LeverActionStatus.getLeverActionStatus();
    }

    @Override
    public void execute() {
        if (ObjectUtils.isEmpty(this.clickedBlock))
            return;

        if (ObjectUtils.notEqual(this.clickedBlock.getType(), Material.LEVER))
            return;

        if (BooleanUtils.isFalse(this.action.isRightClick()))
            return;

//        레버를 당긴 유저는 status 에 존재하는가?
        if (this.leverActionStatus.isUserExist(this.player)) {//존재하지 않는다면 해당유저를 추가합니다.
            this.leverActionStatus.addLeverActionEvent(this.player, LocalDateTime.now().getSecond()); //존재하지 않는다면 새로생성 후 add
            return;
        }

//        active option
        if (ObjectUtils.notEqual(this.leverActionStatus.getActiveTime(this.player), LocalDateTime.now().getSecond())) {
            this.leverActionStatus.removeStatus(this.player);
            return; //다르면 무조건 당겨짐
        }

        playerSendMsgComponentExchanger(this.player, "레버를 천천히 당겨주세요.", ColorType.RED);
        this.event.setCancelled(true);
    }
}
